<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç«å“é›·è¾¾ | Sailson AI</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}">
    <style>
        :root { --primary-color: #D32F2F; --bg-color: #FAFAFA; --sidebar-width: 260px; }
        body { background-color: var(--bg-color); font-family: 'Inter', sans-serif; height: 100vh; display: flex; margin: 0; overflow: hidden; }
        
        /* ä¾§è¾¹æ ï¼šä¿æŒç®€æ´ç™½ */
        .sidebar { width: var(--sidebar-width); background: #fff; border-right: 1px solid #eee; padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .logo-area { display: flex; align-items: center; gap: 10px; margin-bottom: 30px; cursor: pointer; }
        .logo-img { height: 32px; }
        .history-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; }
        .history-item { padding: 10px; font-size: 0.85rem; color: #555; cursor: pointer; border-radius: 6px; margin-bottom: 4px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .history-item:hover { background: #F5F5F7; }
        .history-item.active { background: #FFEBEE; color: var(--primary-color); font-weight: 600; }

        /* ä¸»åŒºåŸŸå¸ƒå±€ï¼šå·¦å°å³å¤§æ¯”ä¾‹ */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; justify-content: center; }
        .container-box { width: 100%; max-width: 1200px; }
        
        .glass-card { background: #fff; border: 1px solid #E5E5E5; border-radius: 16px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); height: 100%; }

        /* è¾“å…¥æ§ä»¶æ ·å¼ */
        .form-control, .form-select { padding: 12px; border-radius: 10px; border: 1px solid #E0E0E0; margin-bottom: 15px; font-size: 0.9rem; }
        .btn-submit { background: var(--primary-color); color: white; border: none; padding: 14px; border-radius: 10px; width: 100%; font-weight: 600; transition: 0.2s; }
        .btn-submit:hover { background: #B71C1C; transform: translateY(-1px); }

        /* === æ ¸å¿ƒä¼˜åŒ–ï¼šæŠ¥è¡¨å®½å±æ¸²æŸ“æ ·å¼ === */
        #reportOutput { width: 100% !important; }
        #reportOutput table { 
            width: 100% !important; 
            table-layout: fixed; 
            border-collapse: collapse; 
            margin: 20px 0; 
            border: 1px solid #eee; 
            border-radius: 10px; 
            overflow: hidden; 
        }
        #reportOutput th { background: #F8F9FA; padding: 15px 10px; text-align: center; color: #666; font-weight: 600; border-bottom: 2px solid #EEE; }
        #reportOutput td { padding: 15px 10px; vertical-align: middle; border-bottom: 1px solid #F1F3F5; text-align: center; font-size: 0.9rem; word-wrap: break-word; }
        #reportOutput tr:hover { background-color: #FFF9F9; }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo-area" onclick="location.reload()">
            <img src="{{ url_for('static', filename='logo.png') }}" class="logo-img">
            <span style="font-weight: 700; font-size: 1.1rem;">ç«å“ç›‘æ§</span>
        </div>
        <button onclick="location.reload()" class="btn btn-outline-danger w-100 mb-4" style="border-radius: 10px;">+ æ–°ç›‘æ§ä»»åŠ¡</button>
        <div class="text-muted small fw-bold mb-2">å†å²ç›‘æ§æŠ¥å‘Š</div>
        <ul class="history-list" id="historyList"></ul>
        <a href="/" style="margin-top:auto; text-decoration:none; color:#666; font-size:0.9rem;">â† è¿”å›é¦–é¡µ</a>
    </aside>

    <main class="main-content">
        <div class="container-box">
            <div class="row g-4 h-100">
                <div class="col-lg-4">
                    <div class="glass-card">
                        <h6 class="fw-bold mb-3">ğŸ“¡ ç›‘æ§é…ç½®</h6>
                        <label class="small text-muted mb-1">ç«å“ TikTok URL</label>
                        <input type="text" id="urlInput" class="form-control" placeholder="ç²˜è´´ä¸»é¡µé“¾æ¥...">
                        
                        <label class="small text-muted mb-1">ç›‘æ§æ—¶é—´æ®µ</label>
                        <div class="row g-2 mb-3">
                            <div class="col-6"><input type="date" id="startDate" class="form-control mb-0"></div>
                            <div class="col-6"><input type="date" id="endDate" class="form-control mb-0"></div>
                        </div>
                        
                        <button onclick="startMonitor()" id="runBtn" class="btn-submit">ğŸš€ å¯åŠ¨äº‘ç«¯æ¢æµ‹</button>
                        <div class="mt-4 p-3 rounded bg-light">
                            <small class="text-muted">ğŸ’¡ æç¤ºï¼šç³»ç»Ÿå°†è‡ªåŠ¨åŒæ­¥äº‘ç«¯è§†é¢‘æ•°æ®ï¼Œä¸ºæ‚¨ç²¾å‡†åˆ†æäº’åŠ¨çˆ†å‘ç‚¹åŠå†…å®¹ç‰¹å¾ã€‚</small>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8">
                    <div class="glass-card" style="min-height: 600px; overflow-y: auto;">
                        <div id="loading" class="text-center py-5 mt-5" style="display:none;">
                            <div class="spinner-border text-danger" style="width: 3rem; height: 3rem;"></div>
                            <h5 class="mt-4 fw-bold">ğŸ•µï¸ æ­£åœ¨äº‘ç«¯åŒæ­¥æ•°æ®...</h5>
                            <p class="text-muted">å·²è¿æ¥ Apify å®æ—¶æŠ“å–è¯¥æ—¶é—´æ®µå†…çš„è§†é¢‘æŒ‡æ ‡</p>
                        </div>
                        <div id="reportOutput">
                            <div class="text-center py-5 mt-5 opacity-25">
                                <div style="font-size: 70px;">ğŸ“Š</div>
                                <h5 class="mt-3">æŠ¥å‘Šå°†åœ¨æ­¤å¤„ç”Ÿæˆ</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // åˆå§‹åŒ–æ—¥æœŸï¼šæœ€è¿‘ 7 å¤©
        window.onload = () => {
            const end = new Date();
            const start = new Date();
            start.setDate(end.getDate() - 7);
            document.getElementById('endDate').value = end.toISOString().split('T')[0];
            document.getElementById('startDate').value = start.toISOString().split('T')[0];
            loadHistory();
        };

        async function startMonitor() {
            const url = document.getElementById('urlInput').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const out = document.getElementById('reportOutput');
            const ld = document.getElementById('loading');
            const btn = document.getElementById('runBtn');

            if(!url) return alert("è¯·è¾“å…¥ä¸»é¡µé“¾æ¥");

            out.style.display = 'none';
            ld.style.display = 'block';
            btn.disabled = true;

            try {
                const r = await fetch('/monitor_competitors', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        competitor_name: url, 
                        startDate: start, 
                        endDate: end 
                    })
                });
                const d = await r.json();
                ld.style.display = 'none';
                out.style.display = 'block';
                out.innerHTML = `<div class="fade-in">${d.result}</div>`;
                loadHistory();
            } catch(e) { 
                alert("æŠ“å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– API ä½™é¢");
                ld.style.display = 'none';
            } finally { btn.disabled = false; }
        }

        async function loadHistory() {
            const r = await fetch('/get_history');
            const list = await r.json();
            const ul = document.getElementById('historyList');
            ul.innerHTML = '';
            list.filter(i => i.type==='competitor').forEach(item => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerText = item.title;
                li.onclick = async () => {
                    const res = await fetch(`/get_record/${item.id}`);
                    const d = await res.json();
                    document.getElementById('reportOutput').innerHTML = `<div class="fade-in">${d.result}</div>`;
                    document.getElementById('reportOutput').style.display = 'block';
                };
                ul.appendChild(li);
            });
        }
    </script>
</body>
</html>