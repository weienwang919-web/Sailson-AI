<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç«å“é›·è¾¾ | Sailson AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}">
    <style>
        :root { --primary-color: #D32F2F; --bg-color: #FAFAFA; --sidebar-width: 280px; }
        body { background-color: var(--bg-color); font-family: 'Inter', sans-serif; height: 100vh; display: flex; overflow: hidden;}
        
        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: #fff; border-right: 1px solid #E5E5E5; padding: 20px; display: flex; flex-direction: column; }
        .sidebar-header { margin-bottom: 30px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .sidebar-logo { height: 32px; width: auto; }
        .sidebar-title { font-weight: 700; font-size: 1.1rem; }
        .new-chat-btn { background: var(--primary-color); color: white; border: none; padding: 12px; border-radius: 10px; width: 100%; font-weight: 600; margin-bottom: 20px; transition: 0.2s; }
        .new-chat-btn:hover { background: #B71C1C; transform: translateY(-1px); }
        .history-list { flex-grow: 1; overflow-y: auto; list-style: none; padding: 0; }
        .history-item { padding: 10px 14px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; color: #333; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-item:hover { background: #F5F5F7; }
        .history-item.active { background: #FFEBEE; color: var(--primary-color); font-weight: 600; }
        .back-home { margin-top: auto; padding-top: 20px; border-top: 1px solid #eee; text-decoration: none; color: #666; font-size: 0.9rem; }

        /* Main */
        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
        .container-box { max-width: 1000px; margin: 0 auto; }
        .glass-card { background: #fff; border: 1px solid #E5E5E5; border-radius: 20px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        .form-control, .form-select { padding: 12px; border-radius: 10px; border: 1px solid #E0E0E0; margin-bottom: 15px; }
        .btn-submit { background: var(--primary-color); color: white; border: none; padding: 12px; border-radius: 10px; width: 100%; font-weight: 600; }
        .btn-submit:hover { background: #B71C1C; }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header" onclick="location.reload()">
            <img src="{{ url_for('static', filename='logo.png') }}" class="sidebar-logo">
            <span class="sidebar-title">ç«å“ç›‘æ§</span>
        </div>
        <button onclick="location.reload()" class="new-chat-btn">+ æ–°ç›‘æ§ä»»åŠ¡</button>
        <div class="text-muted small fw-bold mb-2">å†å²æŠ¥å‘Š</div>
        <ul class="history-list" id="historyList"></ul>
        <a href="/" class="back-home">â† è¿”å›é¦–é¡µ</a>
    </aside>

    <main class="main-content">
        <div class="container-box">
            <h2 class="fw-bold mb-4">ç«å“æ•°æ®é›·è¾¾</h2>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="glass-card">
                        <label class="fw-bold mb-2">ç«å“ä¸»é¡µ (URL)</label>
                        <textarea class="form-control" id="urlsInput" rows="6" placeholder="https://tiktok.com/@..."></textarea>
                        <label class="fw-bold mb-2">å‘¨æœŸ</label>
                        <select class="form-select" id="timeRange">
                            <option value="7">è¿‡å» 7 å¤©</option>
                            <option value="30">è¿‡å» 30 å¤©</option>
                        </select>
                        <button onclick="startMonitor()" id="monitorBtn" class="btn-submit">ğŸš€ å¯åŠ¨ç›‘æ§</button>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="glass-card" style="min-height: 500px;">
                        <div id="reportOutput">
                            <div class="text-center text-muted py-5 mt-5">
                                <div style="font-size: 40px;">ğŸ“¡</div>
                                <p>æŠ¥å‘Šå°†ç”Ÿæˆåœ¨è¿™é‡Œ</p>
                            </div>
                        </div>
                        <div id="loading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-danger"></div>
                            <p class="mt-2 text-muted">æ­£åœ¨çˆ¬å–æ•°æ®å¹¶ç”Ÿæˆæ´å¯Ÿ...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        window.onload = loadHistory;

        async function startMonitor() {
            const urls = document.getElementById('urlsInput').value;
            const days = document.getElementById('timeRange').value;
            const output = document.getElementById('reportOutput');
            const loading = document.getElementById('loading');
            
            if(!urls) { alert("è¯·è¾“å…¥é“¾æ¥"); return; }
            
            output.style.display = 'none';
            loading.style.display = 'block';

            const response = await fetch('/monitor_competitors', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ urls, days })
            });
            const data = await response.json();
            
            loading.style.display = 'none';
            output.style.display = 'block';
            output.innerHTML = data.result;
            loadHistory();
        }

        async function loadHistory() {
            const res = await fetch('/get_history');
            const list = await res.json();
            const ul = document.getElementById('historyList');
            ul.innerHTML = '';
            list.forEach(item => {
                if(item.type === 'competitor') {
                    const li = document.createElement('li');
                    li.className = 'history-item';
                    li.innerText = item.title;
                    li.onclick = async () => {
                        const r = await fetch(`/get_record/${item.id}`);
                        const d = await r.json();
                        document.getElementById('reportOutput').innerHTML = d.result;
                        document.getElementById('reportOutput').style.display = 'block';
                    };
                    ul.appendChild(li);
                }
            });
        }
    </script>
</body>
</html>