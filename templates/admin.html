<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†åå° | Sailson AI</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}">
    <style>
        body { background-color: #FAFAFA; font-family: 'Inter', sans-serif; }
        .navbar { background: #fff; border-bottom: 1px solid #eee; padding: 15px 30px; }
        .navbar-brand { font-weight: 700; color: #333; }
        .nav-link { color: #666; margin: 0 10px; }
        .nav-link:hover { color: #2962FF; }
        .container-main { max-width: 1400px; margin: 40px auto; padding: 0 20px; }
        .stat-card { background: #fff; border-radius: 16px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .stat-number { font-size: 2rem; font-weight: 700; color: #2962FF; }
        .stat-label { color: #999; font-size: 0.9rem; margin-top: 5px; }
        .table-custom { background: #fff; border-radius: 12px; overflow: hidden; }
        .table-custom th { background: #f8f9fa; font-weight: 600; padding: 15px; }
        .table-custom td { padding: 12px 15px; }
        .btn-custom { border-radius: 8px; padding: 8px 16px; font-weight: 600; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container-fluid">
            <span class="navbar-brand">Sailson AI - ç®¡ç†åå°</span>
            <div>
                <a href="/" class="nav-link d-inline">é¦–é¡µ</a>
                <a href="/my-stats" class="nav-link d-inline">æˆ‘çš„ç»Ÿè®¡</a>
                <a href="/admin" class="nav-link d-inline">ç®¡ç†åå°</a>
                <a href="/logout" class="nav-link d-inline">ç™»å‡º</a>
            </div>
        </div>
    </nav>

    <div class="container-main">
        <h2 class="mb-4">ğŸ“Š å…¨å±€ç»Ÿè®¡ï¼ˆæœ¬æœˆï¼‰</h2>

        <div class="row">
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <div class="stat-number">Â¥{{ "%.2f"|format(global_stats.total_cost) }}</div>
                    <div class="stat-label">æ€»æ¶ˆè´¹</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <div class="stat-number">{{ global_stats.active_users }}</div>
                    <div class="stat-label">æ´»è·ƒç”¨æˆ·</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <div class="stat-number">{{ global_stats.total_count }}</div>
                    <div class="stat-label">æ€»åˆ†ææ¬¡æ•°</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <div class="stat-number">Â¥{{ "%.2f"|format(global_stats.avg_cost) }}</div>
                    <div class="stat-label">å¹³å‡æˆæœ¬/æ¬¡</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="stat-card">
                    <h5 class="mb-3">ğŸ“ˆ éƒ¨é—¨æ¶ˆè´¹æ’è¡Œ</h5>
                    <table class="table table-hover table-custom">
                        <thead>
                            <tr>
                                <th>éƒ¨é—¨</th>
                                <th>æ¶ˆè´¹é‡‘é¢</th>
                                <th>ä½¿ç”¨æ¬¡æ•°</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dept in dept_stats %}
                            <tr>
                                <td>{{ dept.department }}</td>
                                <td>Â¥{{ "%.2f"|format(dept.cost) }}</td>
                                <td>{{ dept.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="col-md-6">
                <div class="stat-card">
                    <h5 class="mb-3">ğŸ‘¥ ç”¨æˆ·æ¶ˆè´¹æ’è¡Œï¼ˆTop 10ï¼‰</h5>
                    <table class="table table-hover table-custom">
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·</th>
                                <th>éƒ¨é—¨</th>
                                <th>æ¶ˆè´¹é‡‘é¢</th>
                                <th>ä½¿ç”¨æ¬¡æ•°</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in user_stats %}
                            <tr>
                                <td>{{ user.real_name }}</td>
                                <td>{{ user.department }}</td>
                                <td>Â¥{{ "%.2f"|format(user.cost) }}</td>
                                <td>{{ user.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="m-0">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h5>
                <button class="btn btn-primary btn-custom" onclick="showAddUserModal()">â• æ·»åŠ æ–°ç”¨æˆ·</button>
            </div>
            <table class="table table-hover table-custom">
                <thead>
                    <tr>
                        <th>ç”¨æˆ·å</th>
                        <th>å§“å</th>
                        <th>éƒ¨é—¨</th>
                        <th>è§’è‰²</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in all_users %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>{{ user.real_name }}</td>
                        <td>{{ user.department }}</td>
                        <td>
                            {% if user.role == 'admin' %}
                            <span class="badge bg-danger">ç®¡ç†å‘˜</span>
                            {% else %}
                            <span class="badge bg-primary">ç”¨æˆ·</span>
                            {% endif %}
                        </td>
                        <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                        <td>
                            {% if user.username != 'admin' %}
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser({{ user.id }}, '{{ user.username }}')">åˆ é™¤</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- æ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ·»åŠ æ–°ç”¨æˆ·</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label class="form-label">ç”¨æˆ·å</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å¯†ç </label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">çœŸå®å§“å</label>
                            <input type="text" class="form-control" name="real_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">éƒ¨é—¨</label>
                            <select class="form-control" name="department" required>
                                <option value="é¡¹ç›®ä¸€ç»„">é¡¹ç›®ä¸€ç»„</option>
                                <option value="é¡¹ç›®äºŒç»„">é¡¹ç›®äºŒç»„</option>
                                <option value="é¡¹ç›®ä¸‰ç»„">é¡¹ç›®ä¸‰ç»„</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">è§’è‰²</label>
                            <select class="form-control" name="role" required>
                                <option value="user">æ™®é€šç”¨æˆ·</option>
                                <option value="admin">ç®¡ç†å‘˜</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="submitAddUser()">æ·»åŠ </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let addUserModal;

        window.onload = function() {
            addUserModal = new bootstrap.Modal(document.getElementById('addUserModal'));
        };

        function showAddUserModal() {
            addUserModal.show();
        }

        async function submitAddUser() {
            const form = document.getElementById('addUserForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            try {
                const resp = await fetch('/admin/add_user', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await resp.json();

                if (resp.ok) {
                    alert('âœ… ç”¨æˆ·æ·»åŠ æˆåŠŸï¼');
                    location.reload();
                } else {
                    alert('âŒ ' + (result.error || 'æ·»åŠ å¤±è´¥'));
                }
            } catch(e) {
                alert('âŒ è¯·æ±‚å¤±è´¥ï¼š' + e.message);
            }
        }

        async function deleteUser(userId, username) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" å—ï¼Ÿ`)) return;

            try {
                const resp = await fetch(`/admin/delete_user/${userId}`, {
                    method: 'DELETE'
                });

                const result = await resp.json();

                if (resp.ok) {
                    alert('âœ… ç”¨æˆ·å·²åˆ é™¤');
                    location.reload();
                } else {
                    alert('âŒ ' + (result.error || 'åˆ é™¤å¤±è´¥'));
                }
            } catch(e) {
                alert('âŒ è¯·æ±‚å¤±è´¥ï¼š' + e.message);
            }
        }
    </script>
</body>
</html>
